<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Maaş &amp; Kur Hesaplayıcı</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Maaş &amp; Kur Hesaplayıcı ile teklif edilen maaşı enflasyon ve döviz kurlarına göre hemen karşılaştır, reel alım gücü farkını öğren."
    />
    <meta
      name="keywords"
      content="maaş hesaplayıcı,enflasyon hesabı,döviz kuru hesaplama,usd try,eur try,reel zam"
    />
    <meta name="author" content="Yekta Ulaş Kesik" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://yektaulas.com/maas-kur-hesaplayici" />
    <meta property="og:locale" content="tr_TR" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Maaş &amp; Kur Hesaplayıcı" />
    <meta
      property="og:description"
      content="Teklif edilen maaşın gerçek değerini EUR, USD ve enflasyon bazında saniyeler içinde hesapla."
    />
    <meta
      property="og:url"
      content="https://yektaulas.com/maas-kur-hesaplayici"
    />
    <meta
      property="og:image"
      content="https://yektaulas.com/maas-kur-hesaplayici/backgroun-image.jpg"
    />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Maaş &amp; Kur Hesaplayıcı" />
    <meta
      name="twitter:description"
      content="Enflasyon ve döviz kurlarına göre reel maaş farkını hesapla."
    />
    <meta
      name="twitter:image"
      content="https://yektaulas.com/maas-kur-hesaplayici/backgroun-image.jpg"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Maaş & Kur Hesaplayıcı",
        "url": "https://yektaulas.com/maas-kur-hesaplayici",
        "description": "Teklif edilen maaşı enflasyon, USD ve EUR değişimine göre karşılaştıran ücretsiz web uygulaması.",
        "inLanguage": "tr",
        "applicationCategory": "FinanceApplication",
        "operatingSystem": "Any",
        "author": {
          "@type": "Person",
          "name": "Yekta Ulaş Kesik",
          "url": "https://github.com/yektaulas"
        }
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #edf2f7;
        --bg-soft: #f4f7fb;
        --card: #ffffff;
        --border: #e2e8f0;
        --text: #111827;
        --muted: #6b7280;
        --accent: #2563eb;
        --accent2: #22c55e;
        --danger: #ef4444;
        --shadow-card: 0 20px 40px rgba(15, 23, 42, 0.12);
        --radius-lg: 18px;
        --radius-md: 14px;
        --radius-pill: 999px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Inter', 'Roboto', system-ui, -apple-system,
          BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
      }

      body {
        min-height: 100vh;
        background-image: url(./backgroun-image.jpg);
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 24px;
        color: var(--text);
      }
      .app {
        width: 100%;
        height: 100%;
        margin: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .main-card {
        width: 100%;
        max-width: 1100px;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        border-radius: 28px;
        padding: 26px 26px 24px;
        backdrop-filter: blur(10px);
        margin-bottom: 56px;
      }

      .footer-note {
        margin-top: auto;
        text-align: center;
        font-size: 0.78rem;
        color: var(--muted);
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding-bottom: 8px;
      }

      .footer-note a {
        color: inherit;
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .footer-note a:hover {
        color: var(--accent);
      }
      .made-by-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .made-by-link svg {
        width: 16px;
        height: 16px;
      }
      @media (max-width: 900px) {
        body {
          padding: 12px;
        }
        .main-card {
          padding: 18px;
          border-radius: 22px;
        }
      }

      header {
        text-align: center;
        margin-bottom: 48px;
      }

      header h1 {
        font-size: 1.9rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        margin-bottom: 4px;
        color: #020617;
      }

      header p {
        font-size: 0.92rem;
        color: var(--muted);
      }

      .content-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1.4fr);
        grid-template-areas:
          'form rates'
          'results results';
        gap: 18px;
        margin-top: 18px;
      }

      .form-card {
        grid-area: form;
      }

      .rates-card {
        grid-area: rates;
      }

      .results-card {
        grid-area: results;
      }

      .card {
        background: var(--card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
        padding: 18px 18px 16px;
      }

      .card h2 {
        font-size: 1.02rem;
        margin-bottom: 2px;
      }

      .card-subtitle {
        font-size: 0.78rem;
        color: var(--muted);
        margin-bottom: 10px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 10px;
        margin-top: 16px;
      }

      .form-grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      @media (max-width: 600px) {
        .form-grid-2 {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      label {
        font-size: 0.82rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      label span.info {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      input[type='number'],
      .money-input {
        width: 100%;
        padding: 9px 10px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        font-size: 0.88rem;
        transition: border-color 0.15s ease, box-shadow 0.15s ease,
          background 0.15s;
      }

      input[type='number']:focus,
      .money-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
        background: #ffffff;
      }

      input[type='number']::placeholder,
      .money-input::placeholder {
        color: #cbd5e1;
      }

      /* Input wrappers for prefix/suffix (currency and percent) */
      .input-with-suffix,
      .input-with-prefix {
        position: relative;
      }

      .input-with-suffix .suffix,
      .input-with-prefix .prefix {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #374151;
        font-weight: 600;
        pointer-events: none;
      }

      .input-with-prefix .prefix {
        left: 12px;
        right: auto;
      }

      /* Make room inside inputs for the prefix/suffix */
      .input-with-suffix input,
      .input-with-suffix .money-input {
        padding-right: 36px;
      }

      .input-with-prefix input,
      .input-with-prefix .money-input,
      .input-with-prefix input[type='number'] {
        padding-left: 32px;
      }

      .hint {
        font-size: 0.74rem;
        color: #9ca3af;
      }

      .results-card {
        display: flex;
        flex-direction: column;
        gap: 10px;
        height: 100%;
        justify-content: space-between;
      }

      .calculate-btn {
        width: 100%;
        border-radius: 10px;
        border: none;
        padding: 10px 16px;
        font-size: 1rem;
        font-weight: 600;
        color: white;
        cursor: pointer;
        background: linear-gradient(90deg, #2563eb, #22c55e);
        box-shadow: 0 6px 14px rgba(37, 99, 235, 0.18);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s;
      }

      /* Spinner */
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.6);
        border-top-color: rgba(255, 255, 255, 1);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        vertical-align: -2px;
        margin-right: 8px;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .calculate-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.18);
      }

      .calculate-btn:active {
        transform: translateY(0);
        box-shadow: 0 5px 12px rgba(37, 99, 235, 0.14);
      }

      .calculate-btn:disabled {
        opacity: 0.6;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .error-text {
        margin-top: 6px;
        font-size: 0.78rem;
        color: var(--danger);
        min-height: 1em;
      }

      .mini-note {
        font-size: 0.8rem;
        color: var(--muted);
      }

      /* Exchange cards */

      .rate-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        margin-top: 16px;
      }

      @media (max-width: 750px) {
        .rate-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .rate-card {
        background: var(--bg-soft);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        padding: 10px 12px;
        height: 131px;
      }

      .rate-label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .rate-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: #111827;
      }

      .rate-chip {
        font-size: 0.7rem;
        padding: 2px 7px;
        border-radius: 999px;
        background: #e5f2ff;
        color: #2563eb;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .rate-value {
        font-size: 1rem;
        font-weight: 600;
        color: #0f172a;
      }

      .rate-sub {
        display: flex;
        flex-direction: column;
        margin-top: 8px;
        font-size: 0.75rem;
        color: var(--muted);
      }

      .rate-sub span.change {
        font-weight: 600;
      }

      .rate-sub span.up {
        color: var(--accent2);
      }

      .rate-sub span.down {
        color: var(--danger);
      }

      .rate-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 16px;
        gap: 8px;
      }

      .rate-fetch-btn {
        border-radius: 999px;
        border: 1px solid #c4d4f5;
        padding: 7px 10px;
        font-size: 0.8rem;
        background: #e0edff;
        color: #1d4ed8;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: background 0.12s ease, transform 0.12s ease,
          box-shadow 0.12s;
      }

      .rate-fetch-btn:hover {
        background: #d4e4ff;
        box-shadow: 0 4px 10px rgba(148, 163, 184, 0.25);
        transform: translateY(-1px);
      }

      .rate-fetch-btn:disabled {
        opacity: 0.6;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .rate-status-text {
        font-size: 0.6rem;
        color: var(--muted);
        text-align: right;
        flex: 1;
      }

      .rate-status-text.error {
        color: var(--danger);
      }

      .rate-status-text.ok {
        color: #16a34a;
      }

      /* Real purchasing power table */

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        font-size: 0.85rem;
      }

      thead {
        background: #f9fafb;
      }

      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }

      th {
        font-size: 0.78rem;
        color: #6b7280;
        font-weight: 600;
        text-align: center;
      }

      td.metric {
        font-weight: 500;
        color: #111827;
        white-space: nowrap;
      }

      td.center {
        text-align: center;
      }

      .badge-up,
      .badge-down {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.78rem;
        padding: 2px 8px;
        border-radius: 999px;
        font-weight: 500;
      }

      .badge-up {
        background: #dcfce7;
        color: #166534;
      }

      .badge-down {
        background: #fee2e2;
        color: #b91c1c;
      }

      .diff-text {
        font-size: 0.76rem;
        color: #9ca3af;
        margin-top: 2px;
      }

      .diff-text strong.down {
        color: var(--danger);
      }

      .diff-text strong.up {
        color: var(--accent2);
      }

      .empty-placeholder {
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: 8px;
      }
      #inflationHelperCell,
      #usdHelperCell,
      #eurHelperCell {
        text-align: start;
      }
      #eurTryChangeText {
        margin-top: 20px;
      }
      #usdTryChangeText {
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .content-grid {
          grid-template-columns: minmax(0, 1fr);
          grid-template-areas:
            'form'
            'results'
            'rates';
        }

        .card {
          padding: 16px;
        }

        table {
          width: 100%;
          margin-top: 12px;
        }

        thead {
          display: none;
        }

        table,
        tbody,
        tr,
        td {
          display: block;
          width: 100%;
        }

        tbody tr {
          background: var(--bg-soft);
          border: 1px solid var(--border);
          border-radius: var(--radius-md);
          padding: 12px;
          margin-bottom: 12px;
        }

        tbody tr:last-child {
          margin-bottom: 0;
        }

        td {
          border: none;
          padding: 4px 0;
        }

        td.metric {
          font-size: 0.95rem;
          margin-bottom: 6px;
        }

        .col-nominal,
        .col-real {
          display: none;
        }

        td.center {
          text-align: left;
        }

        #inflationHelperCell,
        #usdHelperCell,
        #eurHelperCell {
          text-align: left;
        }

        .results-card {
          gap: 12px;
        }

        .empty-placeholder {
          margin-top: 4px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Maaşını Enflasyon ve Dövize Göre Karşılaştır</h1>
        <p>
          Teklif edilen maaşın gerçek değerini Euro, Dolar ve Enflasyon'a göre
          hemen hesapla.
        </p>
      </header>
      <!-- İÇERİK GRIDİ -->
      <main class="main-card" role="main">
        <div class="content-grid">
          <!-- Salary & Inflation -->
          <section class="card form-card">
            <h2>Maaş &amp; Enflasyon</h2>

            <div class="form-grid form-grid-2">
              <div class="field">
                <label for="currentSalary" title="Şu an aldığın maaş">
                  Mevcut Maaş
                </label>
                <div class="input-with-suffix">
                  <input
                    id="currentSalary"
                    class="money-input"
                    type="text"
                    inputmode="numeric"
                    pattern="[0-9.]*"
                    placeholder="22.104"
                  />
                  <span class="suffix">₺</span>
                </div>
              </div>

              <div class="field">
                <label for="proposedSalary" title="Yeni maaş">
                  Teklif Edilen Maaş
                </label>
                <div class="input-with-suffix">
                  <input
                    id="proposedSalary"
                    class="money-input"
                    type="text"
                    inputmode="numeric"
                    pattern="[0-9.]*"
                    placeholder="28,735"
                  />
                  <span class="suffix">₺</span>
                </div>
              </div>

              <div class="field">
                <label
                  for="inflation"
                  title="Enflasyon, reel zammı hesaplamak için kullanılır."
                >
                  Yıllık Enflasyon
                </label>
                <div class="input-with-prefix">
                  <span class="prefix">%</span>
                  <input id="inflation" type="number" min="0" step="0.1" />
                </div>
              </div>
              <div class="field">
                <label for="calculateBtn">&nbsp;</label>
                <button id="calculateBtn" class="calculate-btn">
                  <span>Hesapla</span>
                </button>
                <div id="calcError" class="error-text"></div>
              </div>
            </div>
          </section>
          <section class="card rates-card">
            <h2
              title="EUR/USD çapraz kurunu ve EUR/TRY – USD/TRY değerlerini, geçen yıl
              ortalamasıyla birlikte gösterir."
            >
              Kur Bilgileri
            </h2>

            <div class="rate-grid">
              <div class="rate-card">
                <div class="rate-label-row">
                  <span class="rate-title">EUR / TRY</span>
                  <span class="rate-chip"> <span>↕</span> Yıllık değişim </span>
                </div>
                <div id="eurTryNowValue" class="rate-value">–</div>
                <div class="rate-sub">
                  <span>
                    Geçen yıl ort.: <span id="eurTryLastValue">–</span><br
                  /></span>
                  <span id="eurTryChangeText" class="change"></span>
                </div>
              </div>

              <div class="rate-card">
                <div class="rate-label-row">
                  <span class="rate-title">USD / TRY</span>
                  <span class="rate-chip"> <span>↕</span> Yıllık değişim </span>
                </div>
                <div id="usdTryNowValue" class="rate-value">–</div>
                <div class="rate-sub">
                  <span
                    >Geçen yıl ort.: <span id="usdTryLastValue">–</span><br
                  /></span>
                  <span id="usdTryChangeText" class="change"></span>
                </div>
              </div>
            </div>
            <div class="rate-actions">
              <div id="rateStatus" class="rate-status-text">
                * Frankfurter (ECB) verisi kullanılır.
              </div>
            </div>
          </section>
          <!-- Real Purchasing Power Table -->
          <section class="card results-card">
            <h2
              title="Nominal zam oranını; enflasyona, USD/TRY ve EUR/TRY değişimine göre
              karşılaştırır."
            >
              Reel Alım Gücü Tablosu
            </h2>

            <table
              title="Tabloyu görmek için üstte maaş bilgilerini doldur ve sağdaki “Hesapla” butonuna bas."
            >
              <thead>
                <tr>
                  <th>Metrik</th>
                  <th class="center col-nominal">Nominal Zam %</th>
                  <th class="center col-real">Reel Zam %</th>
                  <th class="center">Reel Fark</th>
                  <th>Açıklama</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="metric">Enflasyon</td>
                  <td class="center col-nominal" id="inflationNominalCell">
                    –
                  </td>
                  <td class="center col-real" id="inflationRealCell">–</td>
                  <td class="center" id="inflationBadgeCell">–</td>
                  <td id="inflationHelperCell">
                    <span class="diff-text">Henüz hesaplanmadı.</span>
                  </td>
                </tr>
                <tr>
                  <td class="metric">USD / TRY</td>
                  <td class="center col-nominal" id="usdNominalCell">–</td>
                  <td class="center col-real" id="usdRealCell">–</td>
                  <td class="center" id="usdBadgeCell">–</td>
                  <td id="usdHelperCell">
                    <span class="diff-text">Henüz hesaplanmadı.</span>
                  </td>
                </tr>
                <tr>
                  <td class="metric">EUR / TRY</td>
                  <td class="center col-nominal" id="eurNominalCell">–</td>
                  <td class="center col-real" id="eurRealCell">–</td>
                  <td class="center" id="eurBadgeCell">–</td>
                  <td id="eurHelperCell">
                    <span class="diff-text">Henüz hesaplanmadı.</span>
                  </td>
                </tr>
              </tbody>
            </table>
            <p id="tableHint" class="empty-placeholder">
              * Değerler yaklaşık ve bilgilendirme amaçlıdır.
            </p>
          </section>
        </div>
      </main>
      <footer class="footer-note">
        <a
          class="made-by-link"
          href="https://github.com/yektaulas"
          target="_blank"
          rel="noopener noreferrer"
        >
          Made with
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 640 640"
            fill="#E90606"
          >
            <!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
            <path
              d="M305 151.1L320 171.8L335 151.1C360 116.5 400.2 96 442.9 96C516.4 96 576 155.6 576 229.1L576 231.7C576 343.9 436.1 474.2 363.1 529.9C350.7 539.3 335.5 544 320 544C304.5 544 289.2 539.4 276.9 529.9C203.9 474.2 64 343.9 64 231.7L64 229.1C64 155.6 123.6 96 197.1 96C239.8 96 280 116.5 305 151.1z"
            />
          </svg>
          by Yekta Ulaş
        </a>
        <div style="font-size: 4px; margin-top: 4px">
          Bg image:
          <a
            href="http://www.freepik.com"
            target="_blank"
            rel="noopener noreferrer"
            >Designed by Layerace / Freepik</a
          >
        </div>
      </footer>
    </div>

    <script>
      (function () {
        const apiBase = 'https://api.frankfurter.app';

        // Elements
        const $ = (id) => document.getElementById(id);

        const currentSalaryInput = $('currentSalary');
        const proposedSalaryInput = $('proposedSalary');
        const inflationInput = $('inflation');
        const rateStatus = $('rateStatus');
        const eurTryNowValue = $('eurTryNowValue');
        const eurTryLastValue = $('eurTryLastValue');
        const eurTryChangeText = $('eurTryChangeText');
        const usdTryNowValue = $('usdTryNowValue');
        const usdTryLastValue = $('usdTryLastValue');
        const usdTryChangeText = $('usdTryChangeText');
        const calculateBtn = $('calculateBtn');
        const calcError = $('calcError');
        const inflationNominalCell = $('inflationNominalCell');
        const inflationRealCell = $('inflationRealCell');
        const inflationBadgeCell = $('inflationBadgeCell');
        const inflationHelperCell = $('inflationHelperCell');
        const usdNominalCell = $('usdNominalCell');
        const usdRealCell = $('usdRealCell');
        const usdBadgeCell = $('usdBadgeCell');
        const usdHelperCell = $('usdHelperCell');
        const eurNominalCell = $('eurNominalCell');
        const eurRealCell = $('eurRealCell');
        const eurBadgeCell = $('eurBadgeCell');
        const eurHelperCell = $('eurHelperCell');

        // Formatting helpers for salary inputs (thousands separator with dots)
        function sanitizeToDigits(s) {
          return (s || '').toString().replace(/\D/g, '');
        }

        function formatWithDots(digits) {
          if (!digits) return '';
          return digits.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function bindThousandInput(el) {
          // initialize dataset.raw and formatted display
          el.dataset.raw = sanitizeToDigits(el.value);
          el.value = formatWithDots(el.dataset.raw);

          el.addEventListener('input', function (e) {
            const raw = sanitizeToDigits(el.value);
            el.dataset.raw = raw;
            el.value = formatWithDots(raw);
            // move caret to end for simplicity
            try {
              el.setSelectionRange(el.value.length, el.value.length);
            } catch (err) {
              /* ignore */
            }
          });

          el.addEventListener('paste', function (e) {
            e.preventDefault();
            const text =
              (e.clipboardData || window.clipboardData).getData('text') || '';
            const raw = sanitizeToDigits(text);
            el.dataset.raw = raw;
            el.value = formatWithDots(raw);
          });
        }

        function getNumberFromFormattedInput(el) {
          const raw = el.dataset.raw || sanitizeToDigits(el.value);
          return raw ? Number(raw) : NaN;
        }

        // FX data state
        let eurNow = null;
        let usdNow = null;
        let eurLastAvg = null;
        let usdLastAvg = null;
        const STORAGE_KEY = 'fx_rates_v1';

        // Save rates to sessionStorage so they persist while the tab is open
        function saveRatesToSession() {
          try {
            const payload = {
              eurNow,
              usdNow,
              eurLastAvg,
              usdLastAvg,
              timestamp: Date.now(),
            };
            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
          } catch (e) {
            console.warn('Session storage not available', e);
          }
        }

        // Load rates from sessionStorage if present
        function loadRatesFromSession() {
          try {
            const raw = sessionStorage.getItem(STORAGE_KEY);
            if (!raw) return false;
            const p = JSON.parse(raw);
            if (
              typeof p.eurNow === 'number' &&
              typeof p.usdNow === 'number' &&
              typeof p.eurLastAvg === 'number' &&
              typeof p.usdLastAvg === 'number'
            ) {
              eurNow = p.eurNow;
              usdNow = p.usdNow;
              eurLastAvg = p.eurLastAvg;
              usdLastAvg = p.usdLastAvg;
              return true;
            }
          } catch (e) {
            console.warn('Failed to parse session rates', e);
          }
          return false;
        }

        function clearSessionRates() {
          try {
            sessionStorage.removeItem(STORAGE_KEY);
          } catch (e) {
            /* ignore */
          }
        }

        function formatPercent(v) {
          if (!isFinite(v)) return '–';
          return (
            v.toLocaleString('tr-TR', {
              minimumFractionDigits: 1,
              maximumFractionDigits: 1,
            }) + ' %'
          );
        }

        function setRateStatus(text, type) {
          rateStatus.textContent = text;
          rateStatus.classList.remove('error', 'ok');
          if (type === 'error') rateStatus.classList.add('error');
          if (type === 'ok') rateStatus.classList.add('ok');
        }

        function formatChangeText(_label, diff) {
          // Return HTML that includes an arrow and a colored percent span
          // so the rate cards keep the up/down arrow and coloring.
          // If diff >= 0, FX rose -> TRY lost value (red/down).
          // If diff < 0, FX fell -> TRY gained value (green/up).
          const absVal = Math.abs(diff).toLocaleString('tr-TR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
          const isTryGained = diff < 0; // true => show green/up
          const arrow = isTryGained ? '↑' : '↓';
          const cls = isTryGained ? 'up' : 'down';
          // Wrap the whole sentence so its color follows the up/down class
          if (diff >= 0) {
            return `<span class="${cls}">${arrow} TL geçen yıl %${absVal} değer kaybetti</span>`;
          }
          return `<span class="${cls}">${arrow} TL geçen yıl %${absVal} değer kazandı</span>`;
        }

        async function fetchRates() {
          try {
            setRateStatus('Kurlar çekiliyor...', '');

            const now = new Date();
            const currentYear = now.getFullYear();
            const previousYear = currentYear - 1;
            const start = `${previousYear}-01-01`;
            const end = `${previousYear}-12-31`;

            // Güncel EUR->TRY,USD
            const latestResp = await fetch(
              `${apiBase}/latest?from=EUR&to=TRY,USD`
            );
            if (!latestResp.ok) throw new Error('Latest fetch failed');
            const latestData = await latestResp.json();

            const eurTryLatest = latestData.rates?.TRY;
            const eurUsdLatest = latestData.rates?.USD;

            if (!eurTryLatest || !eurUsdLatest) {
              throw new Error('Eksik EUR verisi');
            }

            const usdTryLatest = eurTryLatest / eurUsdLatest;

            // Geçen yıl zaman serisi EUR->TRY,USD
            const histResp = await fetch(
              `${apiBase}/${start}..${end}?from=EUR&to=TRY,USD`
            );
            if (!histResp.ok) throw new Error('History fetch failed');
            const histData = await histResp.json();

            const rates = histData.rates || {};
            const days = Object.keys(rates);

            const eurTryList = [];
            const usdTryList = [];

            for (const d of days) {
              const r = rates[d];
              if (!r) continue;
              const eurTry = r.TRY;
              const eurUsd = r.USD;
              if (typeof eurTry === 'number' && typeof eurUsd === 'number') {
                eurTryList.push(eurTry);
                usdTryList.push(eurTry / eurUsd);
              }
            }

            if (!eurTryList.length || !usdTryList.length) {
              throw new Error('Yeterli tarihsel veri yok');
            }

            const avg = (arr) =>
              arr.reduce((sum, v) => sum + v, 0) / arr.length;

            eurNow = eurTryLatest;
            usdNow = usdTryLatest;
            eurLastAvg = avg(eurTryList);
            usdLastAvg = avg(usdTryList);

            // Ekrana yaz
            const eurUsdCross = eurTryLatest / usdTryLatest;
            eurTryNowValue.textContent = eurTryLatest.toFixed(4);
            eurTryLastValue.textContent = eurLastAvg.toFixed(4);
            const eurDiffPct = ((eurTryLatest - eurLastAvg) / eurLastAvg) * 100;
            eurTryChangeText.innerHTML = formatChangeText('artış', eurDiffPct);

            usdTryNowValue.textContent = usdTryLatest.toFixed(4);
            usdTryLastValue.textContent = usdLastAvg.toFixed(4);
            const usdDiffPct = ((usdTryLatest - usdLastAvg) / usdLastAvg) * 100;
            usdTryChangeText.innerHTML = formatChangeText('artış', usdDiffPct);
            setRateStatus(
              `Kurlar yüklendi · yıl: ${previousYear} ortalaması & bugün`,
              'ok'
            );

            // Persist to session storage
            saveRatesToSession();

            return true;
          } catch (err) {
            console.error(err);
            setRateStatus(
              'Kurlar yüklenemedi. Tekrar dene veya farklı bir zamanda açmayı dene.',
              'error'
            );
            return false;
          }
        }

        // If session has rates, populate the UI from them and return true.
        // Otherwise return false.
        function populateFromSessionIfAvailable() {
          if (!loadRatesFromSession()) return false;
          const eurUsdCross = eurNow / usdNow;
          eurTryNowValue.textContent = (eurNow || 0).toFixed(4);
          eurTryLastValue.textContent = (eurLastAvg || 0).toFixed(4);
          const eurDiffPct = ((eurNow - eurLastAvg) / eurLastAvg) * 100;
          eurTryChangeText.innerHTML = formatChangeText('artış', eurDiffPct);

          usdTryNowValue.textContent = (usdNow || 0).toFixed(4);
          usdTryLastValue.textContent = (usdLastAvg || 0).toFixed(4);
          const usdDiffPct = ((usdNow - usdLastAvg) / usdLastAvg) * 100;
          usdTryChangeText.innerHTML = formatChangeText('artış', usdDiffPct);
          return true;
        }

        function setDiffCell(metricLabel, realPercent) {
          // Reel zamın kendisi (ör: +3.3, -4.2)
          const isUp = realPercent >= 0;
          const absVal = Math.abs(realPercent).toLocaleString('tr-TR', {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1,
          });

          const badgeClass = isUp ? 'badge-up' : 'badge-down';
          const arrow = isUp ? '↑' : '↓';
          const moreOrLess = isUp ? 'daha fazla' : 'daha az';

          const labelText =
            metricLabel === 'Enflasyon'
              ? 'Enflasyona göre alım gücün'
              : metricLabel === 'USD'
              ? 'Dolar paritesine göre alım gücün'
              : 'Euro paritesine göre alım gücün';

          const mainText = `
              <span class="${badgeClass}">
                <span>${arrow}</span>
                <span>%${absVal}</span>
              </span>
            `;

          const helperText = `
              <span class="diff-text">
                ${labelText}
                <strong class="${
                  isUp ? 'up' : 'down'
                }">%${absVal}</strong> ${moreOrLess}
              </span>
            `;

          // pick target cells by metric
          if (metricLabel === 'Enflasyon') {
            if (inflationBadgeCell) inflationBadgeCell.innerHTML = mainText;
            if (inflationHelperCell) inflationHelperCell.innerHTML = helperText;
          } else if (metricLabel === 'USD') {
            if (usdBadgeCell) usdBadgeCell.innerHTML = mainText;
            if (usdHelperCell) usdHelperCell.innerHTML = helperText;
          } else {
            if (eurBadgeCell) eurBadgeCell.innerHTML = mainText;
            if (eurHelperCell) eurHelperCell.innerHTML = helperText;
          }
        }

        function clearDiffCell(metricLabel, msg) {
          const helper = `<span class="diff-text">${msg}</span>`;
          if (metricLabel === 'Enflasyon') {
            if (inflationBadgeCell) inflationBadgeCell.innerHTML = '–';
            if (inflationHelperCell) inflationHelperCell.innerHTML = helper;
          } else if (metricLabel === 'USD') {
            if (usdBadgeCell) usdBadgeCell.innerHTML = '–';
            if (usdHelperCell) usdHelperCell.innerHTML = helper;
          } else {
            if (eurBadgeCell) eurBadgeCell.innerHTML = '–';
            if (eurHelperCell) eurHelperCell.innerHTML = helper;
          }
        }

        function calculate() {
          calcError.textContent = '';
          const currentSalary = getNumberFromFormattedInput(currentSalaryInput);
          const proposedSalary =
            getNumberFromFormattedInput(proposedSalaryInput);
          const inflation = parseFloat(inflationInput.value);

          if (
            !isFinite(currentSalary) ||
            !isFinite(proposedSalary) ||
            currentSalary <= 0 ||
            proposedSalary <= 0
          ) {
            calcError.textContent =
              'Lütfen geçerli bir mevcut maaş ve teklif edilen maaş gir.';
            return;
          }

          if (
            !isFinite(eurNow) ||
            !isFinite(usdNow) ||
            !isFinite(eurLastAvg) ||
            !isFinite(usdLastAvg)
          ) {
            calcError.textContent =
              'Hesaplama için kur bilgisi gerekiyor. Lütfen tekrar deneyin.';
            return;
          }

          const nominalRaise =
            ((proposedSalary - currentSalary) / currentSalary) * 100;

          // Enflasyon satırı
          inflationNominalCell.textContent = formatPercent(nominalRaise);

          if (isFinite(inflation)) {
            const realRaiseInflation = nominalRaise - inflation;
            inflationRealCell.textContent = formatPercent(realRaiseInflation);
            setDiffCell('Enflasyon', realRaiseInflation);
          } else {
            inflationRealCell.textContent = '–';
            clearDiffCell(
              'Enflasyon',
              'Enflasyon girilmediği için reel fark hesaplanamadı.'
            );
          }

          // USD satırı
          const usdCurrentOld = currentSalary / usdLastAvg;
          const usdOfferNow = proposedSalary / usdNow;
          const realRaiseUsd =
            ((usdOfferNow - usdCurrentOld) / usdCurrentOld) * 100;

          usdNominalCell.textContent = formatPercent(nominalRaise);
          usdRealCell.textContent = formatPercent(realRaiseUsd);

          usdNominalCell.textContent = formatPercent(nominalRaise);
          usdRealCell.textContent = formatPercent(realRaiseUsd);
          setDiffCell('USD', realRaiseUsd);

          // EUR satırı
          const eurCurrentOld = currentSalary / eurLastAvg;
          const eurOfferNow = proposedSalary / eurNow;
          const realRaiseEur =
            ((eurOfferNow - eurCurrentOld) / eurCurrentOld) * 100;

          eurNominalCell.textContent = formatPercent(nominalRaise);
          eurRealCell.textContent = formatPercent(realRaiseEur);

          eurNominalCell.textContent = formatPercent(nominalRaise);
          eurRealCell.textContent = formatPercent(realRaiseEur);
          setDiffCell('EUR', realRaiseEur);
        }

        // On load, try to populate UI from session cache so users keep data
        // when they refresh or navigate within the tab.
        populateFromSessionIfAvailable();

        // Bind formatting behavior to salary inputs
        bindThousandInput(currentSalaryInput);
        bindThousandInput(proposedSalaryInput);

        // Spinner helper
        const spinnerHtml =
          '<span class="spinner" aria-hidden="true"></span><span>Yükleniyor</span>';

        // Ensure rates are available: try session first, otherwise fetch.
        async function ensureRates() {
          // Try to populate from session cache
          if (populateFromSessionIfAvailable()) return true;

          // Not present in session -> fetch
          const ok = await fetchRates();
          return ok;
        }

        // When user clicks "Hesapla", ensure rates are available (from session
        // or API), then run calculation. Show spinner and disable controls while running.
        calculateBtn.addEventListener('click', async function () {
          calcError.textContent = '';

          const originalContent = calculateBtn.innerHTML;
          try {
            calculateBtn.disabled = true;
            calculateBtn.innerHTML = spinnerHtml;

            const ok = await ensureRates();
            if (!ok) {
              calcError.textContent =
                'Kurlar yüklenemedi, hesaplama yapılamıyor.';
              return;
            }

            calculate();
          } finally {
            calculateBtn.disabled = false;
            calculateBtn.innerHTML = originalContent;
          }
        });
      })();
    </script>
  </body>
</html>
